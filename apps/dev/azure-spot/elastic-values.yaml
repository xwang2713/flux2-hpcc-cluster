apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: elk
  namespace: hpcc-systems
spec:
  #test:
  #  enable: true
  values:
    elasticsearch:
      tolerations:
        - key: "kubernetes.azure.com/scalesetpriority"
          operator: "Equal"
          value:  "spot"
          effect: "NoSchedule"
      enabled: true
      description: "HPCC Managed Elasticsearch"
      antiAffinity: "soft"
      replicas: 1
      minimumMasterNodes: 1
      labels: {"managedby" : "HPCC"}
      clusterHealthCheckParams: "wait_for_status=[yellow,green]&timeout=1s"
      volumeClaimTemplate:
        accessModes: [ "ReadWriteOnce" ]
        resources:
          requests:
            storage: 5Gi
    filebeat:
      tolerations:
        - key: "kubernetes.azure.com/scalesetpriority"
          operator: "Equal"
          value:  "spot"
          effect: "NoSchedule"
        - key: "HPCCCriticalOnly"
          operator: "Equal"
          value:  "true"
          effect: "NoSchedule"
        - key: "HPCCThorOnly"
          operator: "Equal"
          value:  "true"
          effect: "NoSchedule"
      description: "HPCC Managed filebeat"
      labels: {"managedby" : "HPCC"}
      filebeatConfig:
        filebeat.yml: |
          filebeat.inputs:
          - type: container
            paths:
            - /var/log/containers/esdl-sandbox-*.log
            - /var/log/containers/eclwatch-*.log
            - /var/log/containers/mydali-*.log
            - /var/log/containers/eclqueries-*.log
            - /var/log/containers/sql2ecl-*.log
            - /var/log/containers/eclservices-*.log
            - /var/log/containers/dfuserver-*.log
            - /var/log/containers/eclscheduler-*.log
            - /var/log/containers/hthor-*.log
            - /var/log/containers/myeclccserver-*.log
            - /var/log/containers/roxie-*.log
            - /var/log/containers/sasha-*.log
            - /var/log/containers/thor-*.log
            processors:
            - add_kubernetes_metadata:
                host: ${NODE_NAME}
                matchers:
                - logs_path:
                    logs_path: "/var/log/containers/"
          output.elasticsearch:
            host: '${NODE_NAME}'
            hosts: '${ELASTICSEARCH_HOSTS:elasticsearch-master:9200}'
            pipeline: 'hpccpipeline'
    kibana:
      tolerations:
        - key: "kubernetes.azure.com/scalesetpriority"
          operator: "Equal"
          value:  "spot"
          effect: "NoSchedule"
      enabled: true
      description: "HPCC Managed Kibana"
      labels: {"managedby" : "HPCC"}
      service:
        type: "LoadBalancer"
